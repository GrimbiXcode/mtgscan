<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Detection Test - iPhone Enhanced</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .result { margin: 10px 0; padding: 15px; background: #f0f0f0; border-radius: 5px; }
        .error { background: #ffe6e6; border-left: 4px solid #ff4444; }
        .success { background: #e6ffe6; border-left: 4px solid #44aa44; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        button { padding: 12px 24px; margin: 10px 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-success { background: #28a745; color: white; }
        .ios-instructions { margin: 10px 0; padding: 15px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3; }
        .step-list { margin: 10px 0; padding-left: 20px; }
        .https-warning { margin: 10px 0; padding: 15px; background: #fff3e0; border-radius: 5px; border-left: 4px solid #ff9800; }
    </style>
</head>
<body>
    <h1>üì± MTG Scanner - iPhone Camera Test</h1>

    <div id="httpsWarning" class="https-warning" style="display: none;">
        <h3>‚ö†Ô∏è HTTPS Erforderlich f√ºr iPhone Kamera</h3>
        <p><strong>Aktuelle URL:</strong> <span id="currentUrl"></span></p>
        <p>iPhone Safari erfordert eine sichere HTTPS-Verbindung f√ºr Kamerazugriff. 
        Bitte √∂ffnen Sie diese Seite √ºber HTTPS oder verwenden Sie einen lokalen Server mit SSL.</p>
    </div>

    <div class="ios-instructions">
        <h3>üìã iPhone Kamera Anleitung:</h3>
        <ol class="step-list">
            <li><strong>HTTPS verwenden:</strong> Stellen Sie sicher, dass die URL mit "https://" beginnt</li>
            <li><strong>Safari verwenden:</strong> √ñffnen Sie die Seite direkt in Safari (nicht im privaten Modus)</li>
            <li><strong>Kamera-Berechtigung:</strong> Tippen Sie auf "Erlauben" wenn nach Kamerazugriff gefragt wird</li>
            <li><strong>Safari Einstellungen:</strong> Gehen Sie zu Einstellungen > Safari > Kamera > Diese Website > Erlauben</li>
        </ol>
    </div>

    <div class="result info">
        <h3>üîß Verf√ºgbare Tests:</h3>
        <button class="btn-primary" onclick="showDeviceInfo()">üì± Ger√§teinformationen</button>
        <button class="btn-primary" onclick="testHTTPS()">üîí HTTPS Status</button>
        <button class="btn-warning" onclick="testCameraSupport()">üì∑ Kamera Support</button>
        <button class="btn-success" onclick="testCameraAccess()">üé• Kamera Zugriff</button>
        <button class="btn-primary" onclick="testWithFallback()">üîÑ iPhone Fallback Test</button>
    </div>

    <div id="results"></div>

    <script type="module">
        // Check HTTPS on load
        window.addEventListener('load', function() {
            const currentUrl = window.location.href;
            document.getElementById('currentUrl').textContent = currentUrl;

            if (!window.location.protocol.includes('https') && window.location.hostname !== 'localhost') {
                document.getElementById('httpsWarning').style.display = 'block';
            }
        });

        // Utility functions for iPhone detection
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }

        function isIOSSafari() {
            return isIOS() && /Safari/.test(navigator.userAgent) && !/CriOS|FxiOS/.test(navigator.userAgent);
        }

        function getSafariVersion() {
            const match = navigator.userAgent.match(/Version\/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        // Import CameraManager for testing (with error handling)
        let CameraManager = null;
        try {
            const module = await import('./src/camera.js');
            CameraManager = module.default;
        } catch (error) {
            console.warn('CameraManager nicht verf√ºgbar:', error.message);
        }

        window.testHTTPS = function() {
            const resultsDiv = document.getElementById('results');
            const isHTTPS = window.location.protocol === 'https:';
            const isLocalhost = window.location.hostname === 'localhost';

            let resultClass = 'error';
            let message = '';

            if (isHTTPS || isLocalhost) {
                resultClass = 'success';
                message = '‚úÖ Sicherer Kontext verf√ºgbar f√ºr Kamerazugriff';
            } else {
                message = '‚ùå HTTPS erforderlich f√ºr iPhone Kamerazugriff';
            }

            let resultHtml = `<div class="result ${resultClass}">`;
            resultHtml += '<h3>üîí HTTPS Status Check:</h3>';
            resultHtml += `<p><strong>Status:</strong> ${message}</p>`;
            resultHtml += `<p><strong>Protokoll:</strong> ${window.location.protocol}</p>`;
            resultHtml += `<p><strong>Hostname:</strong> ${window.location.hostname}</p>`;
            resultHtml += `<p><strong>Sicherer Kontext:</strong> ${window.isSecureContext ? 'Ja' : 'Nein'}</p>`;
            resultHtml += '</div>';

            resultsDiv.innerHTML = resultHtml;
        };

        window.showDeviceInfo = function() {
            const resultsDiv = document.getElementById('results');

            let info = '<div class="result info"><h3>üì± Ger√§teinformationen:</h3>';
            info += '<p><strong>User Agent:</strong> ' + navigator.userAgent + '</p>';
            info += '<p><strong>iOS Ger√§t:</strong> ' + (isIOS() ? 'Ja' : 'Nein') + '</p>';
            info += '<p><strong>Safari Browser:</strong> ' + (isIOSSafari() ? 'Ja' : 'Nein') + '</p>';
            info += '<p><strong>Safari Version:</strong> ' + getSafariVersion() + '</p>';
            info += '<p><strong>MediaDevices API:</strong> ' + (navigator.mediaDevices ? 'Verf√ºgbar' : 'Nicht verf√ºgbar') + '</p>';
            info += '<p><strong>getUserMedia:</strong> ' + (navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? 'Verf√ºgbar' : 'Nicht verf√ºgbar') + '</p>';
            info += '<p><strong>Sicherer Kontext:</strong> ' + (window.isSecureContext ? 'Ja' : 'Nein') + '</p>';
            info += '<p><strong>Bildschirm:</strong> ' + screen.width + 'x' + screen.height + '</p>';
            info += '<p><strong>Pixel Ratio:</strong> ' + window.devicePixelRatio + '</p>';
            info += '</div>';

            resultsDiv.innerHTML = info;
        };

        window.testCameraSupport = async function() {
            const resultsDiv = document.getElementById('results');

            // Basic API availability check
            if (!navigator.mediaDevices) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Kamera Support Test:</h3>
                        <p><strong>Fehler:</strong> MediaDevices API nicht verf√ºgbar</p>
                        <p><strong>iPhone L√∂sung:</strong> Verwenden Sie HTTPS und Safari Browser</p>
                    </div>`;
                return;
            }

            if (!navigator.mediaDevices.getUserMedia) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Kamera Support Test:</h3>
                        <p><strong>Fehler:</strong> getUserMedia nicht verf√ºgbar</p>
                        <p><strong>iPhone L√∂sung:</strong> √úberpr√ºfen Sie Safari Einstellungen</p>
                    </div>`;
                return;
            }

            try {
                // Try to enumerate devices
                let devices = [];
                try {
                    devices = await navigator.mediaDevices.enumerateDevices();
                } catch (error) {
                    console.warn('enumerateDevices failed:', error);
                }

                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                let resultHtml = '<div class="result success">';
                resultHtml += '<h3>‚úÖ Kamera Support Test:</h3>';
                resultHtml += '<p><strong>MediaDevices API:</strong> Verf√ºgbar</p>';
                resultHtml += '<p><strong>getUserMedia:</strong> Verf√ºgbar</p>';
                resultHtml += '<p><strong>Erkannte Kameras:</strong> ' + videoDevices.length + '</p>';

                if (videoDevices.length > 0) {
                    resultHtml += '<p><strong>Kamera Details:</strong></p><ul>';
                    videoDevices.forEach((device, index) => {
                        resultHtml += '<li>' + (device.label || `Kamera ${index + 1}`) + ' (ID: ' + device.deviceId.substring(0, 8) + '...)' + '</li>';
                    });
                    resultHtml += '</ul>';
                }

                resultHtml += '</div>';
                resultsDiv.innerHTML = resultHtml;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Kamera Support Test Fehler:</h3>
                        <p><strong>Fehler:</strong> ${error.name}: ${error.message}</p>
                        ${isIOS() ? '<p><strong>iPhone Tipp:</strong> Stellen Sie sicher, dass Safari Kamerazugriff erlaubt</p>' : ''}
                    </div>`;
            }
        };

        window.testCameraAccess = async function() {
            const resultsDiv = document.getElementById('results');

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Kamera Zugriff Test:</h3>
                        <p><strong>Fehler:</strong> Camera API nicht verf√ºgbar</p>
                        <p><strong>iPhone L√∂sung:</strong> HTTPS verwenden und Safari Berechtigungen √ºberpr√ºfen</p>
                    </div>`;
                return;
            }

            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 }
                    }
                };

                resultsDiv.innerHTML = `
                    <div class="result warning">
                        <h3>‚è≥ Kamera Zugriff wird getestet...</h3>
                        <p>Bitte erlauben Sie den Kamerazugriff wenn gefragt.</p>
                    </div>`;

                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                // Get actual video settings
                const videoTrack = stream.getVideoTracks()[0];
                const settings = videoTrack.getSettings();

                let resultHtml = '<div class="result success">';
                resultHtml += '<h3>‚úÖ Kamera Zugriff erfolgreich!</h3>';
                resultHtml += '<p><strong>Status:</strong> Kamerazugriff gew√§hrt</p>';
                resultHtml += '<p><strong>Aufl√∂sung:</strong> ' + settings.width + 'x' + settings.height + '</p>';
                resultHtml += '<p><strong>Frame Rate:</strong> ' + (settings.frameRate || 'Unbekannt') + ' fps</p>';
                resultHtml += '<p><strong>Facing Mode:</strong> ' + (settings.facingMode || 'Unbekannt') + '</p>';
                resultHtml += '</div>';

                resultsDiv.innerHTML = resultHtml;

                // Stop the stream
                stream.getTracks().forEach(track => track.stop());

            } catch (error) {
                let errorHtml = '<div class="result error">';
                errorHtml += '<h3>‚ùå Kamera Zugriff Fehler:</h3>';
                errorHtml += '<p><strong>Fehler:</strong> ' + error.name + ': ' + error.message + '</p>';

                // iPhone specific error messages
                if (isIOS()) {
                    if (error.name === 'NotAllowedError') {
                        errorHtml += '<div class="ios-instructions">';
                        errorHtml += '<h4>üîß iPhone L√∂sung:</h4>';
                        errorHtml += '<ol>';
                        errorHtml += '<li>Gehen Sie zu <strong>Einstellungen > Safari > Kamera</strong></li>';
                        errorHtml += '<li>W√§hlen Sie <strong>"Fragen" oder "Erlauben"</strong></li>';
                        errorHtml += '<li>Laden Sie diese Seite neu</li>';
                        errorHtml += '</ol>';
                        errorHtml += '</div>';
                    } else if (error.name === 'NotFoundError') {
                        errorHtml += '<p><strong>iPhone Tipp:</strong> Kamera ist m√∂glicherweise von einer anderen App verwendet</p>';
                    }
                }

                errorHtml += '</div>';
                resultsDiv.innerHTML = errorHtml;
            }
        };

        window.testWithFallback = async function() {
            const resultsDiv = document.getElementById('results');

            // Show iPhone specific test
            if (!isIOS()) {
                resultsDiv.innerHTML = `
                    <div class="result info">
                        <h3>‚ÑπÔ∏è iPhone Fallback Test:</h3>
                        <p>Dieser Test ist spezifisch f√ºr iPhone Ger√§te.</p>
                        <p><strong>Ihr Ger√§t:</strong> ${navigator.platform}</p>
                    </div>`;
                return;
            }

            let testResults = [];

            // Test 1: Basic API availability
            testResults.push({
                name: 'MediaDevices API',
                result: !!navigator.mediaDevices,
                message: navigator.mediaDevices ? 'Verf√ºgbar' : 'Nicht verf√ºgbar - HTTPS verwenden'
            });

            // Test 2: getUserMedia availability
            testResults.push({
                name: 'getUserMedia Method',
                result: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                message: (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) ? 'Verf√ºgbar' : 'Nicht verf√ºgbar'
            });

            // Test 3: Secure context
            testResults.push({
                name: 'Sicherer Kontext (HTTPS)',
                result: window.isSecureContext,
                message: window.isSecureContext ? 'Aktiv' : 'HTTPS erforderlich'
            });

            // Test 4: Safari version
            const safariVersion = getSafariVersion();
            testResults.push({
                name: 'Safari Version',
                result: safariVersion >= 11,
                message: `Version ${safariVersion} (${safariVersion >= 11 ? 'Unterst√ºtzt' : 'Zu alt'})`
            });

            // Generate results
            let resultHtml = '<div class="result info">';
            resultHtml += '<h3>üîÑ iPhone Fallback Test Ergebnisse:</h3>';

            testResults.forEach(test => {
                const icon = test.result ? '‚úÖ' : '‚ùå';
                resultHtml += `<p>${icon} <strong>${test.name}:</strong> ${test.message}</p>`;
            });

            const allPassed = testResults.every(test => test.result);

            if (allPassed) {
                resultHtml += '<div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 4px;">';
                resultHtml += '<strong>üéâ Alle Tests bestanden!</strong> iPhone Kamera sollte funktionieren.';
                resultHtml += '</div>';
            } else {
                resultHtml += '<div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 4px;">';
                resultHtml += '<strong>‚ö†Ô∏è Einige Tests fehlgeschlagen.</strong> Befolgen Sie die obigen Anweisungen.';
                resultHtml += '</div>';
            }

            resultHtml += '</div>';
            resultsDiv.innerHTML = resultHtml;
        };

        // Auto-run device info on load
        setTimeout(() => {
            showDeviceInfo();
        }, 500);
    </script>
</body>
</html>
