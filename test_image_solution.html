<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Solution</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-container { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        img { max-width: 200px; border: 1px solid #ddd; margin: 10px 0; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>MTG Scanner Image Solution Test</h1>

    <div class="test-container">
        <h2>Test: Download and Display Image</h2>
        <button onclick="testImageDownload()">Test Image Download</button>
        <div id="downloadStatus"></div>
        <div id="imageContainer"></div>
    </div>

    <script type="module">
        import MTGDatabase from './src/database.js';
        import ScryfallAPI from './src/scryfall.js';

        window.testImageDownload = async function() {
            const statusDiv = document.getElementById('downloadStatus');
            const imageContainer = document.getElementById('imageContainer');

            statusDiv.innerHTML = '<div class="info">Starting test...</div>';
            imageContainer.innerHTML = '';

            try {
                // Initialize components
                const database = new MTGDatabase();
                const scryfallAPI = new ScryfallAPI();

                await database.init();
                statusDiv.innerHTML += '<div class="success">✅ Database initialized</div>';

                // Search for a test card
                const cardName = 'Lightning Bolt';
                statusDiv.innerHTML += '<div class="info">Searching for card: ' + cardName + '</div>';

                const cardData = await scryfallAPI.searchCardByName(cardName);
                statusDiv.innerHTML += '<div class="success">✅ Card found: ' + cardData.name + '</div>';

                // Test the old way (should fail due to CORS)
                const externalImageUrl = cardData.image_uris?.normal;
                if (externalImageUrl) {
                    statusDiv.innerHTML += '<div class="info">Testing external image URL (should fail):</div>';
                    const externalImg = document.createElement('img');
                    externalImg.src = externalImageUrl;
                    externalImg.onerror = () => {
                        statusDiv.innerHTML += '<div class="error">❌ External image failed to load (CORS issue confirmed)</div>';
                    };
                    externalImg.onload = () => {
                        statusDiv.innerHTML += '<div class="success">✅ External image loaded (unexpected)</div>';
                    };
                    imageContainer.appendChild(externalImg);
                }

                // Test the new way (download and store)
                statusDiv.innerHTML += '<div class="info">Testing image download and storage...</div>';

                const imageBlob = await database.downloadImage(externalImageUrl);
                if (imageBlob) {
                    statusDiv.innerHTML += '<div class="success">✅ Image downloaded successfully</div>';

                    // Create object URL from blob
                    const objectURL = URL.createObjectURL(imageBlob);

                    const downloadedImg = document.createElement('img');
                    downloadedImg.src = objectURL;
                    downloadedImg.onload = () => {
                        statusDiv.innerHTML += '<div class="success">✅ Downloaded image displayed successfully!</div>';
                    };
                    downloadedImg.onerror = () => {
                        statusDiv.innerHTML += '<div class="error">❌ Failed to display downloaded image</div>';
                    };

                    const label = document.createElement('p');
                    label.innerHTML = '<strong>Downloaded and stored image:</strong>';
                    imageContainer.appendChild(label);
                    imageContainer.appendChild(downloadedImg);
                } else {
                    statusDiv.innerHTML += '<div class="error">❌ Failed to download image</div>';
                }

                // Test adding card to database
                statusDiv.innerHTML += '<div class="info">Testing card storage with image...</div>';

                try {
                    await database.addCard(cardData);
                    statusDiv.innerHTML += '<div class="success">✅ Card added to database with image data</div>';
                } catch (error) {
                    statusDiv.innerHTML += '<div class="error">❌ Failed to add card: ' + error.message + '</div>';
                }

            } catch (error) {
                statusDiv.innerHTML += '<div class="error">❌ Test failed: ' + error.message + '</div>';
                console.error('Test error:', error);
            }
        };
    </script>
</body>
</html>
